name: Scan, Build, Push & Deploy to Minikube

on:
  push:
    branches:
      - main

jobs:
  # sonarqube:
  #   name: SonarQube
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
  #     - name: SonarQube Scan
  #       uses: SonarSource/sonarqube-scan-action@v6
  #       env:
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-and-push:
    runs-on: ubuntu-latest
    # needs: sonarqube
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/node-remote-test:latest .

      - name: Push Docker Image to Docker Hub Registry
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/node-remote-test:latest

  deploy:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Minikube status
        run: |
          echo "=== Minikube Status ==="
          minikube status || true

          # If Minikube is not running, start it
          if ! minikube status | grep -q "Running"; then
            echo "Minikube is not running. Starting Minikube..."
            minikube start
          else
            echo "Minikube is running. Proceeding with deployment."
          fi

      - name: test kubectl
        run: |
          minikube kubectl -- get pod -A
          
      - name: Create Docker Hub pull secret in Kubernetes
        run: |
          minikube kubectl -- create secret docker-registry dockerhub-secret \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --dry-run=client -o yaml | minikube kubectl -- apply -f -

      - name: Deploy latest image from Docker Hub to Minikube
        run: |
          minikube kubectl -- set image deployment/nodejs-deployment \
            nodejs-app=${{ secrets.DOCKERHUB_USERNAME }}/node-remote-test:latest

      - name: Apply Kubernetes manifests
        run: |
          minikube kubectl -- apply -f k8s/

      - name: Wait for rollout to complete
        run: |  
          minikube kubectl -- rollout status deployment/nodejs-deployment --timeout=120s

      - name: Show service URL
        run: |  
          minikube service nodejs-service --url
